extension SVG {
  static let error = Self("Error") {
    """
    <?xml version="1.0" encoding="UTF-8"?>
    <!--Generator: Apple Native CoreSVG 326-->
    <!DOCTYPE svg
    PUBLIC "-//W3C//DTD SVG 1.1//EN"
           "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 13.1641 12.2266">
     <g>
      <rect height="12.2266" opacity="0" width="13.1641" x="0" y="0"/>
      <path d="M9.78906 0.640625L12.2266 3.35156C12.6484 3.82031 12.7578 4.125 12.7578 4.74219L12.7578 7.48438C12.7578 8.10156 12.6484 8.40625 12.2266 8.875L9.78906 11.5859C9.40625 12 9.01562 12.2266 8.30469 12.2266L4.44531 12.2266C3.74219 12.2266 3.34375 12 2.96875 11.5859L0.523438 8.875C0.109375 8.40625 0 8.10156 0 7.48438L0 4.74219C0 4.125 0.109375 3.82031 0.523438 3.35156L2.96875 0.640625C3.34375 0.226562 3.74219 0 4.44531 0L8.30469 0C9.01562 0 9.40625 0.226562 9.78906 0.640625ZM8.05469 3.64844L6.375 5.3125L4.71094 3.65625C4.60938 3.55469 4.48438 3.5 4.32031 3.5C4.00781 3.5 3.75 3.74219 3.75 4.07031C3.75 4.21875 3.8125 4.35938 3.91406 4.46875L5.5625 6.11719L3.91406 7.76562C3.8125 7.875 3.75 8.01562 3.75 8.16406C3.75 8.49219 4.00781 8.75 4.32031 8.75C4.48438 8.75 4.63281 8.69531 4.73438 8.58594L6.375 6.92969L8.02344 8.58594C8.125 8.69531 8.27344 8.75 8.42969 8.75C8.75781 8.75 9.01562 8.49219 9.01562 8.16406C9.01562 8.00781 8.96094 7.86719 8.84375 7.75781L7.19531 6.11719L8.85156 4.46094C8.97656 4.34375 9.02344 4.21094 9.02344 4.05469C9.02344 3.73438 8.76562 3.48438 8.44531 3.48438C8.29688 3.48438 8.17188 3.53906 8.05469 3.64844Z" fill="currentColor" fill-opacity="0.85"/>
     </g>
    </svg>
    """
  }

  static let failure = Self("Failure") {
    """
    <?xml version="1.0" encoding="UTF-8"?>
    <!--Generator: Apple Native CoreSVG 326-->
    <!DOCTYPE svg
    PUBLIC "-//W3C//DTD SVG 1.1//EN"
           "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 14.4454 14.047">
     <g>
      <rect height="14.047" opacity="0" width="14.4454" x="0" y="0"/>
      <path d="M8.42192 0.714893L13.3204 5.61333C14.2657 6.55864 14.2813 7.48052 13.3438 8.41021L8.41411 13.3477C7.47661 14.2774 6.55474 14.2696 5.61724 13.3243L0.710986 8.42583C-0.226514 7.48052-0.242139 6.56646 0.695361 5.62896L5.62505 0.691455C6.56255-0.238232 7.48442-0.23042 8.42192 0.714893ZM8.69536 4.55864L7.02349 6.22271L5.35942 4.56646C5.25005 4.46489 5.12505 4.41021 4.9688 4.41021C4.64849 4.41021 4.39067 4.65239 4.39067 4.98052C4.39067 5.12896 4.45317 5.26958 4.56255 5.37896L6.21099 7.02739L4.56255 8.67583C4.45317 8.78521 4.39067 8.92583 4.39067 9.07427C4.39067 9.40239 4.64849 9.66021 4.9688 9.66021C5.12505 9.66021 5.27349 9.60552 5.38286 9.49614L7.02349 7.83989L8.67192 9.49614C8.76567 9.60552 8.92192 9.66021 9.07817 9.66021C9.39849 9.66021 9.6563 9.40239 9.6563 9.07427C9.6563 8.91802 9.60161 8.77739 9.49224 8.66802L7.8438 7.02739L9.50005 5.37114C9.61724 5.25396 9.66411 5.12114 9.66411 4.96489C9.66411 4.64458 9.4063 4.39458 9.0938 4.39458C8.93755 4.39458 8.81255 4.44927 8.69536 4.55864Z" fill="currentColor" fill-opacity="0.85"/>
     </g>
    </svg>
    """
  }

  static let warning = Self("Warning") {
    """
    <?xml version="1.0" encoding="UTF-8"?>
    <!--Generator: Apple Native CoreSVG 326-->
    <!DOCTYPE svg
    PUBLIC "-//W3C//DTD SVG 1.1//EN"
    "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 -1 13.2969 12.6953">
    <g transform="translate(0 -1)">
    <rect height="11.6953" opacity="0" width="13.2969" x="0" y="0"/>
    <path d="M7.94531 0.882812L12.6484 9.04688C12.8047 9.32031 12.8906 9.625 12.8906 9.91406C12.8906 10.9062 12.2266 11.6641 11.1406 11.6641L1.75 11.6641C0.664062 11.6641 0 10.9062 0 9.91406C0 9.625 0.078125 9.32812 0.242188 9.04688L4.94531 0.882812C5.27344 0.304688 5.85156 0 6.44531 0C7.03906 0 7.60938 0.304688 7.94531 0.882812ZM5.69531 8.95312C5.69531 9.35156 6.04688 9.66406 6.44531 9.66406C6.84375 9.66406 7.1875 9.35938 7.1875 8.95312C7.1875 8.55469 6.84375 8.23438 6.44531 8.23438C6.03906 8.23438 5.69531 8.55469 5.69531 8.95312ZM5.78906 3.65625L5.875 6.98438C5.88281 7.34375 6.08594 7.54688 6.44531 7.54688C6.78906 7.54688 6.98438 7.35156 6.99219 6.98438L7.09375 3.66406C7.10156 3.29688 6.8125 3.03125 6.4375 3.03125C6.05469 3.03125 5.78125 3.28906 5.78906 3.65625Z" fill="currentColor" fill-opacity="0.85"/>
    </g>
    </svg>
    """
  }
}

public struct DiagnosticLevel {
  var icon: SVG
  var iconColor: PointFreeColor
  var highlightColor: PointFreeColor
  var underlineColor: PointFreeColor?
  var backgroundColor: PointFreeColor
  var detailBackgroundColor: PointFreeColor
  var buttonBackgroundColor: PointFreeColor

  public static let error = Self(
    icon: .error,
    iconColor: .init(rawValue: "#CA0900", darkValue: "#ED2239"),
    highlightColor: .init(rawValue: "#EFE9F2", darkValue: "#3A2C30"),
    underlineColor: .init(rawValue: "#E31315", darkValue: "#E21415"),
    backgroundColor: .init(rawValue: "#FFC0C0", darkValue: "#863432"),
    detailBackgroundColor: .init(rawValue: "#EFDCDC", darkValue: "#402E2B"),
    buttonBackgroundColor: .init(rawValue: "#B7AAA9", darkValue: "#302221")
  )

  public static let issue = Self(
    icon: .failure,
    iconColor: .init(rawValue: "#CA0900", darkValue: "#ED2239"),
    highlightColor: .init(rawValue: "#EFE9F2", darkValue: "#3A2C30"),
    backgroundColor: .init(rawValue: "#FFC0C0", darkValue: "#863432"),
    detailBackgroundColor: .init(rawValue: "#EFDCDC", darkValue: "#402E2B"),
    buttonBackgroundColor: .init(rawValue: "#B7AAA9", darkValue: "#302221")
  )

  public static let knownIssue = Self(
    icon: .failure,
    iconColor: .init(rawValue: "#8E8E93", darkValue: "#98989D"),
    highlightColor: .init(rawValue: "#F4F4F4", darkValue: "#333439"),
    backgroundColor: .init(rawValue: "#CECED1", darkValue: "#5F5F61"),
    detailBackgroundColor: .init(rawValue: "#E0E0E0", darkValue: "#373635"),
    buttonBackgroundColor: .init(rawValue: "#A8A8A8", darkValue: "#292828")
  )

  public static let runtimeWarning = Self(
    icon: .warning,
    iconColor: .init(rawValue: "#A156D5", darkValue: "#A849E8"),
    highlightColor: .init(rawValue: "#E9EAFD", darkValue: "#3A3447"),
    backgroundColor: .init(rawValue: "#D9B8F3", darkValue: "#714088"),
    detailBackgroundColor: .init(rawValue: "#EBE1F2", darkValue: "#3A303C"),
    buttonBackgroundColor: .init(rawValue: "#ACA3AF", darkValue: "#2B252E")
  )

  static let warning = Self(
    icon: .warning,
    iconColor: .init(rawValue: "#FFBA00", darkValue: "#FFC502"),
    highlightColor: .init(rawValue: "#FFFAEA", darkValue: "#3F3A30"),
    underlineColor: .init(rawValue: "#FEC300"),
    backgroundColor: .init(rawValue: "#FFEAAD", darkValue: "#8F7723"),
    detailBackgroundColor: .init(rawValue: "#EFE9D6", darkValue: "#413B29"),
    buttonBackgroundColor: .init(rawValue: "#B4AEA0", darkValue: "#312C1E")
  )
}

public struct Diagnostic<Message: HTML>: HTML {
  let level: DiagnosticLevel
  let message: Message

  public init(level: DiagnosticLevel, @HTMLBuilder message: () -> Message) {
    self.level = level
    self.message = message()
  }

  public var body: some HTML {
    div {
      HStack(spacing: 0) {
        div {
          div {
            level.icon
          }
          .inlineStyle(
            "filter",
            """
            drop-shadow(1px 0 0 white) \
            drop-shadow(-1px 0 0 white) \
            drop-shadow(0 1px 0 white) \
            drop-shadow(0 -1px 0 white)
            """
          )
          .inlineStyle("width", "14px")
        }
        .color(level.iconColor)
        .backgroundColor(level.backgroundColor)
        .inlineStyle("padding", "8px 8px 7px")

        div {
          VStack(spacing: 0.5) {
            message
          }
          .attribute("class", "diagnostic")
        }
        .backgroundColor(level.detailBackgroundColor)
        .color(.black.dark(.white))
        .grow()
        .inlineStyle("padding", "8px")
      }
      .inlineStyle("border-radius", "8px")
      .inlineStyle("border", "0.5px solid \(level.backgroundColor.darkValue!)44")
      .inlineStyle("border", "0.5px solid \(level.backgroundColor.rawValue)44", media: .dark)
      .inlineStyle("overflow", "hidden")
    }
    .inlineStyle(
      "filter",
      """
      drop-shadow(0 0 2px rgba(0,0,0,0.2)) \
      drop-shadow(0 1px 0 rgba(0,0,0,0.2))
      """
    )
  }
}

public struct InlineDiagnostic: HTML {
  let level: DiagnosticLevel
  let message: String

  public var body: some HTML {
    VStack(alignment: .trailing) {
      HStack(spacing: 0.05) {
        div {
          div {
            level.icon
          }
          .inlineStyle(
            "filter",
            """
            drop-shadow(1px 0 0 white) \
            drop-shadow(-1px 0 0 white) \
            drop-shadow(0 1px 0 white) \
            drop-shadow(0 -1px 0 white)
            """
          )
          .inlineStyle("width", "14px")
        }
        .color(level.iconColor)
        .backgroundColor(level.backgroundColor)
        .inlineStyle("padding", "4px 10px 3px 10px")

        div {
          HTMLText(message)
        }
        .backgroundColor(level.backgroundColor)
        .color(.black.dark(.white))
        .attribute("title", message)
        .inlineStyle("min-width", "0")
        .inlineStyle("max-width", "500px")
        .inlineStyle("flex", "1 1")
        .inlineStyle("padding", "3px 30px 3px 8px")
        .inlineStyle("text-overflow", "ellipsis")
        .inlineStyle("overflow", "hidden")
        .inlineStyle("white-space", "nowrap")
      }
      .inlineStyle("border-radius", "3px 0 0 3px")
      .inlineStyle("overflow", "hidden")
    }
  }
}

#if canImport(SwiftUI)
  import SwiftUI

  #Preview {
    ForEach(ColorScheme.allCases, id: \.hashValue) { colorScheme in
      HTMLPreview {
        div {
          style {
            """
            html {
              font-family:-apple-system,Helvetica Neue,Helvetica,Arial,sans-serif;
            }
            @media(prefers-color-scheme: dark) {
              body{background-color:#292A31;}
            }
            """
          }
          VStack {
            InlineDiagnostic(
              level: .warning,
              message: """
                Constant 'blob' inferred to have type '()', which may be unexpected
                """
            )

            InlineDiagnostic(
              level: .error,
              message: """
                Expected '(' in argument list of function declaration
                """
            )

            InlineDiagnostic(
              level: .issue,
              message: """
                XCTAssertEqual failed: ("1") is not equal to ("2")
                """
            )

            InlineDiagnostic(
              level: .knownIssue,
              message: """
                Expected failure: failed
                """
            )

            InlineDiagnostic(
              level: .runtimeWarning,
              message: """
                Publishing changes from background threads is not allowed; \
                make sure to publish values from the main thread \
                (via operators like receive(on:)) \
                on model updates.
                """
            )

            Diagnostic(level: .warning) {
              "Constant 'blob' inferred to have type '()', which may be unexpected"
              br()
              br()
              "Add an explicit type annotation to silence this warning"
            }

            Diagnostic(level: .error) {
              """
              Expected '(' in argument list of function declaration
              """
            }

            Diagnostic(level: .issue) {
              """
              XCTAssertEqual failed: ("1") is not equal to ("2")
              """
            }

            Diagnostic(level: .knownIssue) {
              """
              Expected failure: failed
              """
            }

            Diagnostic(level: .runtimeWarning) {
              """
              Publishing changes from background threads is not allowed; \
              make sure to publish values from the main thread \
              (via operators like receive(on:)) \
              on model updates.
              """
            }
          }
        }
        .inlineStyle("padding", "10px")
      }
      .environment(\.colorScheme, colorScheme)
    }
  }
#endif
