version: 2

jobs:
  build:
    macos:
      xcode: "10.1.0"

    steps:
      - checkout

      - restore_cache:
          keys:
            - brew

      - run:
          name: Mac Info
          command: system_profiler SPSoftwareDataType

      - run:
          name: Install Postgres
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install postgresql

      - run:
          name: Install CommonMark
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install cmark

      - run:
          name: Start Postgres
          command: brew services start postgresql

      - run:
          name: Run Swift tests
          command: make test-oss
          environment:
            SNAPSHOT_ARTIFACTS: $CIRCLE_ARTIFACTS

      - save_cache:
          key: brew
          paths:
            - /usr/local/Homebrew
